window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1000/60)}})();window.cancelRequestAnimFrame=(function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout})();toRadians=function(a){return a*(Math.PI/180)};toDegrees=function(a){return a*(180/Math.PI)};createCanvas=function(g,e,h,d,a){var b=document.createElement("canvas");b.height=d;b.width=h;b.id=e+"canvas";var c=b.getContext("2d");if(a){var f=document.getElementById(g);f.appendChild(b)}return{canvas:b,context:c}};if(is_canvas_supported()){CanvasRenderingContext2D.prototype.setSmoothing=function setSmoothing(a){if(this.hasOwnProperty("webkitImageSmoothingEnabled")){this.webkitImageSmoothingEnabled=a}else{if("mozImageSmoothingEnabled" in this){this.mozImageSmoothingEnabled=a}else{this.imageSmoothingEnabled=a}}}}var Vec=function(a,b){this.x=a;this.y=b};Vec.prototype={add:function(a,b){var c,d;if(typeof(a)=="number"){c=this.x+a;d=this.y+a}else{c=this.x+a.x;d=this.y+a.y}return new Vec(c,d)},add_:function(a){if(typeof(a)=="number"){this.x+=a;this.y+=a}else{this.x+=a.x;this.y+=a.y}return this},dot:function(a){return((this.x*a.x)+(this.y*a.y))},length:function(){return Math.sqrt((this.x*this.x)+(this.y*this.y))},multiply:function(b,a){var c,d;if(typeof(a)=="number"){c=this.x*b;d=this.y*a}else{if(typeof(b)=="number"){c=this.x*b;d=this.y*b}else{c=this.x*b.x;d=this.y*b.y}}return new Vec(c,d)},divide:function(b,a){var c,d;if(typeof(a)=="number"){c=this.x/b;d=this.y/a}else{if(typeof(b)=="number"){c=this.x/b;d=this.y/b}else{c=this.x/b.x;d=this.y/b.y}}return new Vec(c,d)},multiply_:function(a){if(typeof(a)=="number"){this.x*=a;this.y*=a}else{this.x*=a.x;this.y*=a.y}return this},squaredLength:function(a){return(this.x*this.x)+(this.y*this.y)},sum:function(){return this.x+this.y},subtract:function(a){var b,c;if(typeof(a)=="number"){b=this.x-a;c=this.y-a}else{b=this.x-a.x;c=this.y-a.y}return new Vec(b,c)},subtract_:function(a){if(typeof(a)=="number"){this.x-=a;this.y-=a}else{this.x-=a.x;this.y-=a.y}return this},toString:function(){return"["+this.x+","+this.y+"]"}};Array.prototype.remove=function(a,c){var b=this.slice((c||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,b)};Director=function(){var a=this;this.debug=true;this.scenes=new Array();this.scenesLoaded=0;this.entities=new Array();this.activescenes=new Array();this.active=false;this.always=false;this.request=null;this.delta=0;this.previous=null;this.init=function(){if(this.scenes.length){for(var b=0,c=this.scenes.length;b<c;b++){this.checkSceneReady(this.scenes[b])}}else{this.isLoaded()}};this.checkSceneReady=function(c){if(c.isReady){c.init()}else{var b=this;setTimeout(function(){b.checkSceneReady(c)},50)}};this.directorLoaded=function(){this.scenesLoaded++;if(this.scenesLoaded==this.scenes.length){this.init();this.isLoaded()}};this.isLoaded=new Function();this.checkActive=function(){var b=false;if(this.always){b=true}else{for(var c=0,d=this.scenes.length;c<d;c++){if(this.scenes[c].running){b=true;break}}}if(b!==this.active){this.setActive(b)}};this.setActive=function(b){this.active=b;if(this.active){this.loop()}else{this.reset()}};this.alwaysActive=function(b){this.always=b;this.checkActive()};this.renderEntities=function(){for(var c=0,d=this.entities.length;c<d;c++){var b=this.entities[c];if(b.parentAnimation.running){b.renderImage()}}};this.render=function(){var e=new Date().getTime();if(this.previous==null){this.delta=0}else{this.delta=e-this.previous}this.previous=e;for(var b=0,c=this.scenes.length;b<c;b++){var d=this.scenes[b];if(d.running){d.update().renderEntities()}}};this.draw=null;this.reset=function(){cancelRequestAnimFrame(a.request);this.delta=0;this.previous=null};this.loop=function(){if(a.active){a.request=requestAnimFrame(a.loop);a.render();if(a.draw){a.draw()}}}};Entity=function(k,f,h,l,e,n,g,j,c,b,d,m){this.isAnimating=false;this.name=f;this.pos=(h)?new Vec(h.x,h.y):new Vec(0,0);this.size=(l)?new Vec(l.w,l.h):new Vec(0,0);this.zindex=n;this.opacity=(g)?g:1;this.scale=this.getScale(j);this.center=(c)?new Vec(c.x,c.y).multiply(this.scale.x,this.scale.y):new Vec(0,0).multiply(this.scale.x,this.scale.y);this.angle=(b)?b:0;this.radius=0;this.frame=(d)?d:0;this.frameRow=0;this.startFrame=0;this.smooth=m;this.initialised=false;this.boundingSize=new Vec(0,0);this.isRotated=false;this.offscreen=null;this.offscreenLoaded=false;this.scaledCenter=new Vec(0,0);this.scaledSize=new Vec(0,0);this.pattern=false;this.patternLoaded=false;this.parentAnimation=k;if(this.parentAnimation){this.parentAnimation.entities.push(this)}this.isVisible=true;this.animations=new Array();this.image=new Image();this.image.src=(e!=undefined)?e:null;this.imageLoaded=false;this.imageFail=false;var a=this;if(e){this.image.onload=function(){a.imageLoaded=true;if(!a.angle){a.checkLoaded()}};this.image.onerror=function(o){var r=[];for(var p=0,q=a.parentAnimation.entities.length;p<q;p++){if(a.parentAnimation.entities[p].name==f){console.warn(f+" image not loading");r.push(p)}}for(var p=0,q=r.length;p<q;p++){a.parentAnimation.entities.remove(r[p])}a.imageFail=true;a.checkLoaded()}}this.checkLoaded=function(){if(a.imageLoaded&&(a.angle&&a.offscreenLoaded||!a.angle)&&(a.pattern&&a.patternLoaded)||!a.pattern&&!a.imageFail){a.init();a.parentAnimation.entitiesLoaded++;if(a.parentAnimation.entitiesLoaded==a.parentAnimation.entities.length){a.parentAnimation.sceneLoaded()}}else{if(a.imageFail){a.init();if(a.parentAnimation.entitiesLoaded==a.parentAnimation.entities.length){a.parentAnimation.sceneLoaded()}}}};if(e==null&&!!this.name){this.checkLoaded()}return this};Entity.prototype.getScale=function(b){var a=new Vec(1,1);if(!!b){if(typeof(b)=="number"){a=new Vec(b,b)}else{if(typeof(b)=="object"){a=new Vec(b.x,b.y)}}}return a};Entity.prototype.init=function(){if(this.parentAnimation&&this.parentAnimation.canvas&&!this.initialised){this.initialised=true;this.ctxt=this.parentAnimation.canvas.context}};Entity.prototype.setParentScale=function(){if(this.initialised){this.scale=this.initialScale;this.pos.y=this.pos.y;this.pos.x=this.pos.x}else{this.init()}};Entity.prototype.drawOffscreen=function(){var e=this;this.offscreen.context.save();this.offscreen.context.clearRect(0,0,this.boundingSize.x,this.boundingSize.y);var h,j,g,f,c,d,b,a;h=this.frame*this.size.x;j=this.frameRow*this.size.y;g=this.size.x;f=this.size.y;b=this.size.x;a=this.size.y;this.offscreen.context.translate(this.radius,this.radius);this.offscreen.context.rotate(toRadians(this.angle));this.offscreen.context.translate(-this.radius,-this.radius);this.offscreen.context.drawImage(this.RotateImage,h,j,g,f,this.radius-this.center.x,this.radius-this.center.y,b,a);this.image=this.offscreen.canvas;this.offscreen.context.restore()};Entity.prototype.renderImage=function(){if(!this.isVisible){return false}if(typeof(this.scale)=="number"){this.scale=this.getScale(this.scale)}var m=(this.angle)?this.offscreenLoaded:this.imageLoaded;if(m){if(this.ctxt.globalAlpha!==this.opacity*this.parentAnimation.opacity){this.ctxt.globalAlpha=this.opacity*this.parentAnimation.opacity}var G,H;if(this.smooth){this.ctxt.save()}if(this.smooth){this.ctxt.setSmoothing(true)}this.scaledCenter=this.center.multiply(this.scale.x,this.scale.y);this.scaledSize=this.size.multiply(this.scale.x,this.scale.y);if(this.isRotated){G=this.pos.x;H=this.pos.y}else{G=this.pos.x-(this.scaledCenter.x);H=this.pos.y-(this.scaledCenter.y)}if(this.parentAnimation.dirtyClear){var f=(this.angle)?this.pos.x-(this.radius*this.scale.x):G;var g=(this.angle)?this.pos.y-(this.radius*this.scale.y):H;if(f<this.parentAnimation.dirty.minx){this.parentAnimation.dirty.minx=f<<0}if(g<this.parentAnimation.dirty.miny){this.parentAnimation.dirty.miny=g<<0}if(this.angle){if(f+(this.radius*2*this.scale.x)>this.parentAnimation.dirty.maxx){this.parentAnimation.dirty.maxx=1+f+(this.radius*2*this.scale.x)<<0}if(g+(this.radius*2*this.scale.y)>this.parentAnimation.dirty.maxy){this.parentAnimation.dirty.maxy=1+g+(this.radius*2*this.scale.y)<<0}}else{if(f+(this.size.x*this.scale.x)>this.parentAnimation.dirty.maxx){this.parentAnimation.dirty.maxx=1+f+(this.size.x*this.scale.x)<<0}if(g+(this.size.y*this.scale.y)>this.parentAnimation.dirty.maxy){this.parentAnimation.dirty.maxy=1+g+(this.size.y*this.scale.y)<<0}}}var E,F,D,C,j,k,h,d;E=this.frame*this.size.x;F=this.frameRow*this.size.y;D=this.size.x;C=this.size.y;j=G;k=H;h=this.scaledSize.x;d=this.scaledSize.y;var t,p,s,o;t=E;p=j;s=D;o=h;var u,q,r,n;u=F;q=k;r=C;n=d;if(this.isRotated&&this.offscreen){t=0;u=0;s=this.boundingSize.x<<0;r=this.boundingSize.y<<0;var b=(this.radius<<0)*this.scale.x;var c=(this.radius<<0)*this.scale.y;p=p-b;q=q-c;o=s*this.scale.x;n=r*this.scale.y;this.scaledSize.x=s*this.scale.x;this.scaledSize.y=r*this.scale.y;this.scaledCenter.x=b*this.scale.x;this.scaledCenter.y=c*this.scale.y;this.drawOffscreen()}if(q>this.parentAnimation.canvassize.h||p>this.parentAnimation.canvassize.w||q+this.scaledSize.y<0||p+this.scaledSize.x<0){return false}var v,z,A,w;if(q+this.scaledSize.y>this.parentAnimation.canvassize.h){v=true}if(p+this.scaledSize.x>this.parentAnimation.canvassize.w){z=true}if(q<0){A=true}if(p<0){w=true}if(v){var B=(q+this.scaledSize.y)-this.parentAnimation.canvassize.h;r=r-B/this.scale.y;n=n-B}if(z){var B=(p+this.scaledSize.x)-this.parentAnimation.canvassize.w;s=s-B/this.scale.x;o=o-B}if(A){u=u-q/this.scale.y;r=r+q/this.scale.y;n=n+q;q=0}if(w){t=t-p/this.scale.x;s=s+p/this.scale.x;o=o+p;p=0}if(s<0||o<0||r<0||n<0){return false}try{this.ctxt.drawImage(this.image,t,u,s,r,p,q,o,n)}catch(l){}if(this.smooth){this.ctxt.restore()}if(this.isAnimating&&this.animationListener){this.animationListener(this)}}else{var a=this;setTimeout(function(){a.renderImage()},50)}};Entity.prototype.addAnimationListener=function(a){this.animationListener=a;return this};Entity.prototype.addAnimation=function(b){var a;var c=this;switch(b.type){case"Translate":a=new Translate(b,c);break;case"Scale":a=new Scale(b,c);break;case"Opacity":a=new Opacity(b,c);break;case"Rotate":a=new Rotate(b,c);break;case"Sprite":a=new Sprite(b,c);break;case"Bezier":a=new Bezier(b,c);break;case"Pattern":a=new Pattern(b,c);break;case"Emitter":a=new Emit(b,c);break;case"Custom":a=new Custom(b,c);break}this.animations.push(a);return this};Entity.prototype.show=function(){this.visible(true)};Entity.prototype.hide=function(){this.visible(false)};Entity.prototype.visible=function(a){this.isVisible=a;this.parentAnimation.renderEntities();if(this.parentAnimation.director.draw){this.parentAnimation.director.draw()}return this};Entity.prototype.setFrameRow=function(a){this.frameRow=a;this.parentAnimation.renderEntities();if(this.parentAnimation.director.draw){this.parentAnimation.director.draw()}return this};Entity.prototype.play=function(b,a){if(!a){a=0}if(!this.isVisible){console.warn("entity "+this.name+" not visible")}else{this.isAnimating=true;this.parentAnimation.play(b,a,this.name+"_")}};Entity.prototype.playAll=function(){this.isAnimating=true;var a=this;for(var b=0,d=a.animations.length;b<d;b++){var c=a.animations[b].id;a.parentAnimation.start(a.name+"_"+c)}};Entity.prototype.pause=function(a){this.parentAnimation.pause(a,this.name+"_");return this};Animation=function(a){this.obj=a;this.type=a.type;this.entityname=a.entityname;this.animationid=a.animationid;this.runtime=a.runtime;this.delay=a.delay;this.zindex=a.zindex;this.elapsed=0;this.running=false};Scene=function(e,b,g,f,h,d){var a=this;this.parentId=b.parentId;var c=(b.id)?b.id:b.parentId;this.canvas=(g)?createCanvas(b.parentId,c+"offscreen",b.w,b.h,false):createCanvas(b.parentId,c,b.w,b.h,b.append);this.rendercanvas=(g)?createCanvas(b.parentId,c,b.w,b.h,b.append):false;this.dirtyClear=f;this.running=0;this.delta=0;this.pos={x:0,y:0};this.angle=0;this.center=(d)?d:{x:b.w/2,y:b.h/2};this.size={w:b.w,h:b.h};this.opacity=1;this.scale=(h)?h:1;this.entitiesLoaded=0;this.director=e;this.director.scenes.push(this);this.animations=new Object();this.entities=new Array();this.entityIndex=new Object();this.inprogressobj=new Object();this.entitiesAdded=0;this.isReady=false;this.canvassize={w:null,h:null};this.dirty={minx:null,miny:null,maxx:null,maxy:null}};Scene.prototype.sceneLoaded=function(){this.isReady=true;this.director.directorLoaded()};Scene.prototype.init=function(){if(this.entities.length==0){this.sceneLoaded()}this.addEntities();var a=this;this.entities.sort(function(e,f){return e.zindex-f.zindex});for(var b=0,c=this.entities.length;b<c;b++){this.entityIndex[this.entities[b].name]=b}this.director.entities=this.director.entities.concat(this.entities);this.canvassize.w=this.canvas.canvas.width;this.canvassize.h=this.canvas.canvas.height;for(var b=0,c=this.animations.length;b<c;b++){var d=this.animations[b].animation.animationid;a.inprogressobj[d]=0}this.sortProgress().renderEntities()};Scene.prototype.getEntity=function(a){return this.entities[this.entityIndex[a]]};Scene.prototype.clearCanvas=function(){if(this.dirtyClear){if(this.dirty.minx<0){this.dirty.minx=0}if(this.dirty.miny<0){this.dirty.miny=0}if(this.dirty.maxx>this.canvassize.w){this.dirty.maxx=this.canvassize.w}if(this.dirty.maxy>this.canvassize.h){this.dirty.maxy=this.canvassize.h}this.canvas.context.clearRect(this.dirty.minx,this.dirty.miny,this.dirty.maxx-this.dirty.minx,this.dirty.maxy-this.dirty.miny);this.dirty.minx=this.canvassize.w;this.dirty.miny=this.canvassize.h;this.dirty.maxx=0;this.dirty.maxy=0}else{this.canvas.context.clearRect(0,0,this.canvassize.w,this.canvassize.h)}};Scene.prototype.renderEntities=function(){if(!this.isReady){return false}this.clearCanvas();this.canvas.context.save();this.canvas.context.translate(this.pos.x,this.pos.y);if(this.angle){this.canvas.context.translate(this.center.x,this.center.y);this.canvas.context.rotate(toRadians(this.angle));this.canvas.context.translate(-this.center.x,-this.center.y)}if(this.scale!==1){this.canvas.context.translate(this.center.x,this.center.y);this.canvas.context.scale(this.scale,this.scale);this.canvas.context.translate(-this.center.x,-this.center.y)}for(var c=0,d=this.entities.length;c<d;c++){this.entities[c].renderImage()}if(this.angle){}this.canvas.context.restore();if(this.hasSceneAnimations){}if(this.rendercanvas){var a=this.rendercanvas.context;var e=this.canvassize.w;var b=this.canvassize.h;a.clearRect(0,0,e,b);a.drawImage(this.canvas.canvas,0,0)}};Scene.prototype.addEntities=function(){for(var a=0,b=this.entities.length;a<b;a++){this.addEntity(this.entities[a])}};Scene.prototype.addEntity=function(b){var a=this;for(var c=0,d=b.animations.length;c<d;c++){var e=b.animations[c];a.addEntityAnimation([{obj:e,type:e.type,entityname:b.name,animationid:b.name+"_"+e.id,run:e.run,callback:e.end,runtime:e.runtime,delay:e.delay,zindex:b.zindex}])}this.entitiesAdded++;return this};Scene.prototype.addAnimation=function(a){this.hasSceneAnimations=true;var b;switch(a.type){case"Translate":b=new Translate(a,this);break;case"Scale":b=new Scale(a,this);break;case"Opacity":b=new Opacity(a,this);break;case"Rotate":b=new Rotate(a,this);break;case"Emitter":b=new Emit(a,this);break}this.addEntityAnimation([{obj:b,type:b.type,entityname:"Scene_"+this.parentId,animationid:"Scene_"+this.parentId+"_"+b.id,run:b.run,callback:b.end,runtime:b.runtime,delay:b.delay,zindex:this.zindex}],"Scene");return this};Scene.prototype.addEntityAnimation=function(c,g){var a=this;if(!g){g=="Entity"}for(var d=0,e=c.length;d<e;d++){var f=c[d];if(!f.zindex){f.zindex=0}var b=new Animation(f);a.animations[f.animationid]={animation:b,type:g}}};Scene.prototype.waitToStart=function(b){if(this.isReady&&(this.entitiesAdded==this.entities.length)){this.start(b)}else{var a=this;setTimeout(function(){a.waitToStart(b)},50)}};Scene.prototype.start=function(a){if(!this.isReady||(this.entitiesAdded!==this.entities.length)){this.waitToStart(a);return false}if(this.animations[a]&&!this.animations[a].animation.running){this.running++;this.animations[a].animation.running=true;if(!this.inprogressobj[a]){this.inprogressobj[a]=a}if(this.running-1==0){this.director.checkActive()}}};Scene.prototype.play=function(c,b,d){if(!b){b=0}var a=this;if(!d){var d="Scene_"+this.parentId+"_"}setTimeout(function(){var f=c.split(" ");for(var e=0,g=f.length;e<g;e++){a.start(d+f[e])}},b)};Scene.prototype.pause=function(b,e){var c=b.split(" ");if(!e){e="Scene_"+this.parentId+"_"}for(var a=0,d=c.length;a<d;a++){this.stop(e+c[a])}return this};Scene.prototype.sortProgress=function(){var f=this.inprogressobj;var e=0;var g=new Array();for(var a=0,b=this.animations.length;a<b;a++){var d=this.animations[a];g.push([d,d.animation.zindex])}g.sort(function(h,j){return h[1]-j[1]});f=new Object();for(var a=0,b=g.length;a<b;a++){var c=g[a][0].animation.animationid;f[c]=0}return this};Scene.prototype.stop=function(a){if(this.animations[a].animation.running){if(this.animations[a].type=="Entity"){this.getEntity(this.animations[a].animation.entityname).isAnimating=false}this.running--;if(this.inprogressobj[a]){this.inprogressobj[a]=0}this.animations[a].animation.running=false;if(this.running==0){this.director.checkActive()}}};Scene.prototype.update=function(){var a=this;var f=null;var b=0;for(var c in a.inprogressobj){var d=a.inprogressobj[c];if(d){var e=new Date().getTime();if(f){b+=e-f}f=e;if(a.animations[d]){a.action(d,a.animations[d].animation,b)}}}return this};Scene.prototype.action=function(c,b,a){if(b.runtime){if(b.delay>0){b.delay=b.delay-(this.director.delta+a)}else{if(b.delay<0){var a=Math.abs(b.delay);b.delay=0;this.action(c,b,a)}else{if(b.elapsed>=b.runtime){b.obj.obj.run(this.director.delta,b.runtime);this.stop(c);b.elapsed=0;if(!!b.obj.obj.end){b.obj.obj.end()}}else{b.elapsed+=this.director.delta;b.obj.obj.run(this.director.delta+a,b.elapsed+a)}}}}};Translate=function(b,a){this.type=b.type;this.id=b.id;this.runtime=b.runtime;this.delay=b.delay;this.callback=b.callback;this.deltax=null;this.deltay=null;this.scaledy=null;this.scaledx=null;this.x=b.x;this.y=b.y;this.run=function(c,d){if(!this.deltax&&(this.x||this.x==0)){this.scaledx=this.x;this.deltax=(this.scaledx-a.pos.x)/this.runtime}if(!this.deltay&&(this.y||this.y==0)){this.scaledy=this.y;this.deltay=(this.scaledy-a.pos.y)/this.runtime}if(this.deltax){var e=a.pos.x+c*this.deltax;a.pos.x=(e<this.scaledx&&this.deltax>0||e>this.scaledx&&this.deltax<0)?e:this.scaledx}if(this.deltay){var f=a.pos.y+c*this.deltay;a.pos.y=(f<this.scaledy&&this.deltay>0||f>this.scaledy&&this.deltay<0)?f:this.scaledy}};this.end=function(){this.deltax=null;this.deltay=null;this.scaledy=null;this.scaledx=null;if(this.callback){this.callback(a)}}};Scale=function(b,a){this.type=b.type;this.id=b.id;this.runtime=b.runtime;this.delay=b.delay;this.callback=b.callback;this.scaled=new Vec(0,0);this.deltascale=null;this.scale=(typeof(b.scale)=="number")?new Vec(b.scale,b.scale):new Vec(b.scale.x,b.scale.y);this.run=function(c,d){if(!this.deltascale&&!!this.scale){var e=(a.parentAnimation)?a.parentAnimation.scale:1;this.scaled=this.scale.multiply(e);this.deltascale=new Vec(this.scaled.x-a.scale.x,this.scaled.y-a.scale.y).divide(this.runtime)}if(this.deltascale){var f=a.scale.x+c*this.deltascale.x;a.scale.x=(f<this.scaled.x&&this.deltascale.x>0||f>this.scaled.x&&this.deltascale.x<0)?f:this.scaled.x;var g=a.scale.y+c*this.deltascale.y;a.scale.y=(g<this.scaled.y&&this.deltascale.y>0||g>this.scaled.y&&this.deltascale.y<0)?g:this.scaled.y}};this.end=function(){this.scaled=new Vec(0,0);this.deltascale=null;if(this.callback){this.callback(a)}}};Opacity=function(b,a){this.type=b.type;this.id=b.id;this.runtime=b.runtime;this.delay=b.delay;this.callback=b.callback;this.deltaopacity=null;this.opacity=b.opacity;this.run=function(c,d){if(!this.deltaopacity&&(this.opacity||this.opacity==0)){this.deltaopacity=(this.opacity-a.opacity)/this.runtime}if(this.deltaopacity){var e=parseFloat(a.opacity)+c*this.deltaopacity;a.opacity=(e<this.opacity&&this.deltaopacity>0||e>this.opacity&&this.deltaopacity<0)?e:this.opacity}};this.end=function(){this.deltaopacity=null;if(this.callback){this.callback(a)}}};Rotate=function(f,b){this.type=f.type;this.id=f.id;this.runtime=f.runtime;this.delay=f.delay;this.callback=f.callback;this.deltarotate=null;this.rotate=f.rotate;this.image=new Image();this.diff=new Vec(0,0);this.scaledCenter=new Vec(0,0);this.scaledSize=new Vec(0,0);var e=b.size.x/2;var c=b.size.y/2;var g=Math.sqrt(Math.pow(c,2)+Math.pow(e,2));var a=Math.sqrt(Math.pow(b.center.x-e,2)+Math.pow(b.center.y-c,2));b.radius=a+g;this.createRotator=function(){if(b.imageLoaded){if(!b.RotateImage){b.RotateImage=b.image}this.image=b.RotateImage;this.scaledCenter=b.center.multiply(b.scale);this.scaledSize=b.size.multiply(b.scale);this.diff=new Vec(b.radius*2-this.scaledSize.x,b.radius*2-this.scaledSize.y);var h=new Vec(b.pos.x-this.scaledCenter.x-this.diff.x/2,b.pos.y-this.scaledCenter.y-this.diff.y/2);b.boundingSize=new Vec(b.radius*2,b.radius*2);b.offscreen=createCanvas(null,this.id,b.boundingSize.x,b.boundingSize.y,false);if(b.angle){b.isRotated=true}b.offscreenLoaded=true;b.checkLoaded()}else{var d=this;setTimeout(function(){d.createRotator()},50)}};this.createRotator();this.run=function(d,h){b.isRotated=true;if(!this.deltarotate&&(this.rotate||this.rotate==0)){this.deltarotate=(this.rotate-b.angle)/this.runtime}if(this.deltarotate){var j=b.angle+d*this.deltarotate;b.angle=(j<this.rotate&&this.deltarotate>0||j>this.rotate&&this.deltarotate<0)?j:this.rotate}};this.end=function(){if(b.angle==0){b.image=this.image;b.isRotated=false}this.deltarotate=null;if(this.callback){this.callback(b)}}};Sprite=function(b,a){this.type=b.type;this.id=b.id;this.runtime=b.frametime*b.sequence.length;this.delay=b.delay;this.callback=b.callback;this.sequence=b.sequence;this.frametime=b.frametime;this.run=function(c,d){d+=this.frametime*a.startFrame;var e=(d>=this.runtime)?this.sequence.length-1:(d/this.frametime)<<0;a.frame=this.sequence[e]};this.end=function(){if(this.callback){this.callback(a)}}};Bezier=function(b,a){this.type=b.type;this.id=b.id;this.runtime=b.runtime;this.delay=b.delay;this.callback=b.callback;this.points=b.points;this.path=new Path([{x:this.points.start.x,y:this.points.start.y,time:0},{x:this.points.control1.x,y:this.points.control1.y},{x:this.points.control2.x,y:this.points.control2.y},{x:this.points.end.x,y:this.points.end.y,time:100}]);this.run=function(c,d){if(d>=this.runtime){a.pos.x=this.points.end.x*a.parentAnimation.scale;a.pos.y=this.points.end.y*a.parentAnimation.scale}else{var e=this.path.getXYAtTime((d/this.runtime)*100);a.pos.x=e.x*a.parentAnimation.scale;a.pos.y=e.y*a.parentAnimation.scale}};this.end=function(){if(this.callback){this.callback(a)}}};function Path(a){this.points=a;if(a[0].time==undefined||a[a.length-1].time==undefined){throw new Error("all control points must be between two real points")}}Path.prototype.getXYAtTime=function(j){var f=this.points;if(j<f[0].time){return f[0]}if(j>f[f.length-1].time){return f[f.length-1]}var g=0,h=f.length-1;for(var b=1;b<f.length;b++){var e=f[b];if(j<e.time){h=b;break}if(e.time!=undefined){g=b}}var d=h-g;var k=f[g].time,l=f[h].time;j=(j-k)/(l-k);var m=1-j;var o=0,q=0;for(var b=0;b<=d;b++){var e=f[g+b];var a=nCr(d,b)*Math.pow(1-j,d-b)*Math.pow(j,b);o+=a*e.x;q+=a*e.y}return{x:o,y:q}};function nCr(c,b){var d=1;for(var a=1;a<=b;a++){d*=(c+1-a)/a}return d}var Bezier123=function(b,c,g){var a=this;this.pos=g;var h=this.pos.start;var f=this.pos.end;var d=this.pos.control1;var e=this.pos.control2;this.path=new Path([{x:h.x,y:h.y,time:0},{x:d.x,y:d.y},{x:e.x,y:e.y},{x:f.x,y:f.y,time:100}]);this.getPoint=function(j){return this.path.getXYAtTime(j)};this.debug={on:true,mouse:{isDown:false,selected:null},line:{w:1,col:"#ffffff"},box:{w:20,col:"#CC0000",col2:"#0099FF",col3:"#00CC00"}};if(this.debug.on){$(b).mousedown(function(j){a.debug.mouse.isDown=true;a.debug.mouse.selected=a.checkDebugBounds(j.layerX,j.layerY)}).mousemove(function(k){var j=a.debug;if(j.mouse.isDown){if(j.mouse.selected){j.mouse.selected.x=k.layerX;j.mouse.selected.y=k.layerY}}}).mouseup(function(j){a.debug.mouse.isDown=false;if(a.debug.mouse.selected){console.log("start: {x:"+a.pos.start.x+", y:"+a.pos.start.y+"}, end: {x:"+a.pos.end.x+", y:"+a.pos.end.y+"}, control1: {x:"+a.pos.control1.x+", y:"+a.pos.control1.y+"}, control2: {x:"+a.pos.control2.x+", y:"+a.pos.control2.y+"}");a.debug.mouse.selected=null}})}this.checkDebugBounds=function(l,m){var j=this.debug;var k=this.pos;if(l>k.start.x-(j.box.w/2)&&l<k.start.x+(j.box.w/2)&&m>k.start.y-(j.box.w/2)&&m<k.start.y+(j.box.w/2)){return k.start}else{if(l>k.end.x-(j.box.w/2)&&l<k.end.x+(j.box.w/2)&&m>k.end.y-(j.box.w/2)&&m<k.end.y+(j.box.w/2)){return k.end}else{if(l>k.control1.x-(j.box.w/2)&&l<k.control1.x+(j.box.w/2)&&m>k.control1.y-(j.box.w/2)&&m<k.control1.y+(j.box.w/2)){return k.control1}else{if(l>k.control2.x-(j.box.w/2)&&l<k.control2.x+(j.box.w/2)&&m>k.control2.y-(j.box.w/2)&&m<k.control2.y+(j.box.w/2)){return k.control2}else{return null}}}}};this.drawDebug=function(){var j=this.debug;var k=this.pos;c.beginPath();c.moveTo(k.start.x,k.start.y);c.bezierCurveTo(k.control1.x,k.control1.y,k.control2.x,k.control2.y,k.end.x,k.end.y);c.lineWidth=j.line.w;c.strokeStyle=j.line.col;c.stroke();c.beginPath();c.moveTo(k.start.x,k.start.y);c.rect(k.start.x-(j.box.w/2),k.start.y-(j.box.w/2),j.box.w,j.box.w);c.strokeStyle=j.box.col3;c.stroke();c.beginPath();c.rect(k.end.x-(j.box.w/2),k.end.y-(j.box.w/2),j.box.w,j.box.w);c.strokeStyle=j.box.col;c.stroke();c.beginPath();c.rect(k.control1.x-(j.box.w/2),k.control1.y-(j.box.w/2),j.box.w,j.box.w);c.rect(k.control2.x-(j.box.w/2),k.control2.y-(j.box.w/2),j.box.w,j.box.w);c.moveTo(k.start.x,k.start.y);c.lineTo(k.control1.x,k.control1.y);c.moveTo(k.end.x,k.end.y);c.lineTo(k.control2.x,k.control2.y);c.stroke();c.strokeStyle=j.box.col2;c.stroke()}};Pattern=function(b,a){this.type=b.type;this.id=b.id;this.runtime=b.runtime;this.delay=b.delay;this.callback=b.callback;this.repeatType="repeat";this.deltax=null;this.deltay=null;this.x=b.x;this.y=b.y;this.isReady=false;this.patternOffset={x:0,y:0};a.pattern=true;a.patternLoaded=false;this.drawOffscreen=function(){this.offscreen.context.save();this.offscreen.context.clearRect(0,0,a.size.x,a.size.y);this.offscreen.context.translate(this.patternOffset.x,this.patternOffset.y);this.offscreen.context.fillRect(-this.patternOffset.x,-this.patternOffset.y,1278,500);this.offscreen.context.translate(-this.patternOffset.x,-this.patternOffset.y);a.image=this.offscreen.canvas;this.offscreen.context.restore()};this.createPattern=function(){if(a.imageLoaded){this.offscreen=createCanvas(null,this.id,a.size.x,a.size.y,false);this.pattern=this.offscreen.context.createPattern(a.image,this.repeatType);this.offscreen.context.fillStyle=this.pattern;this.isReady=true;this.drawOffscreen();a.patternLoaded=true;a.checkLoaded()}else{var c=this;setTimeout(function(){c.createPattern()},50)}};this.createPattern();this.run=function(c,d){if(!this.deltax&&(this.x||this.x==0)){this.deltax=(this.x-this.patternOffset.x)/this.runtime}if(!this.deltay&&(this.y||this.y==0)){this.deltay=(this.y-this.patternOffset.y)/this.runtime}if(this.deltax){var e=this.patternOffset.x+c*this.deltax;this.patternOffset.x=(e<this.x&&this.deltax>0||e>this.x&&this.deltax<0)?e:this.x}if(this.deltay){var f=this.patternOffset.y+c*this.deltay;this.patternOffset.y=(f<this.y&&this.deltay>0||f>this.y&&this.deltay<0)?f:this.y}if(this.isReady){this.drawOffscreen()}};this.end=function(){this.deltax=null;this.deltay=null;this.patternOffset.x=null;this.patternOffset.y=null;if(this.callback){this.callback(a)}}};Emit=function(b,a){this.type=b.type;this.id=b.id;this.runtime=b.runtime;this.delay=b.delay;this.callback=b.callback;this.particles=b.emitter;this.particles.init();this.isRunning=false;a.imageLoaded=true;this.run=function(c,d){if(!this.isRunning){this.isRunning=true;this.particles.start()}a.image=this.particles.canvas};this.end=function(){this.isRunning=false;this.particles.stop();if(this.callback){this.callback()}}};function Particle(){this.position=new Vec(0,0);this.direction=new Vec(0,0);this.shape="square";this.size=0;this.timeToLive=0;this.sizeSmall=0;this.colour=[];this.drawColour="";this.deltaColour=[];this.sharpness=0}function ParticleEmitter(a,b){this.parentClass=b;this.maxParticles=a.maxParticles;this.lifeSpan=a.lifeSpan.n;this.lifeSpanRandom=a.lifeSpan.rand;this.position=a.position;this.speed=a.speed.n;this.speedRandom=a.speed.rand;this.angle=a.angle.n;this.angleRandom=a.angle.rand;this.gravity=new Vec(a.gravity.x,a.gravity.y);this.size=a.size.n;this.sizeRandom=a.size.rand;this.sizeEnd=a.size.end;this.startColour=[a.startColour.r,a.startColour.g,a.startColour.b,a.startColour.a];this.startColourRandom=[a.startColourRandom.r,a.startColourRandom.g,a.startColourRandom.b,a.startColourRandom.a];this.finishColour=[a.finishColour.r,a.finishColour.g,a.finishColour.b,a.finishColour.a];this.finishColourRandom=[a.finishColourRandom.r,a.finishColourRandom.g,a.finishColourRandom.b,a.finishColourRandom.a];this.gradient=a.gradient||null;this.shape=a.shape;this.imgsrc=a.imgsrc;this.gco=a.gco;this.life=a.life;this.particles=[];this.particleCount=0;this.duration=(a.duration)?a.duration:-1}ParticleEmitter.prototype.init=function(a){if(this.shape=="image"){this.imageParticle=this.loadImage(this.imgsrc)}this.context=a;this.emissionRate=this.maxParticles/this.lifeSpan;this.emitCounter=0};ParticleEmitter.prototype.startParticleEmitter=function(){this.elapsedTime=0;this.emitCounter=0;this.active=true};ParticleEmitter.prototype.stopParticleEmitter=function(){this.active=false;this.elapsedTime=0;this.emitCounter=0};ParticleEmitter.prototype.renderParticles=function(){var a=this.particleCount;while(a--){var b=this.particles[a];this.renderShape(b)}};ParticleEmitter.prototype.renderShape=function(a){switch(a.shape){case"square":this.renderSquare(a);break;case"image":this.renderImage(a);break;case"star":this.renderStar(a);break}};ParticleEmitter.prototype.loadImage=function(c){var a=this;var b=new Image();b.src=c;b.onload=function(){};return b};ParticleEmitter.prototype.renderSquare=function(a){this.context.fillStyle=a.drawColour;this.context.fillRect(parseInt(a.position.x)-(a.size/2),(a.position.y<<0)-(a.size/2),a.size,a.size)};ParticleEmitter.prototype.renderImage=function(b){if(!this.imageParticle){var a=this;this.imageParticle=this.loadImage(this.imgsrc)}this.context.globalAlpha=b.drawOpacity;this.context.drawImage(this.imageParticle,parseInt(b.position.x)-(b.size/2),parseInt(b.position.y)-(b.size/2),b.size,b.size);this.context.globalAlpha=1};ParticleEmitter.prototype.renderStar=function(b){var e=b.size/5;var a=b.points||5;var g=0;var f=2*Math.PI/(a*2);this.context.translate(b.position.x,b.position.y);this.context.beginPath();var c=0;for(i=0;i<a*2;i++){this.context.lineTo((0.5+5*c)*e*Math.cos(i*f),(0.5+5*c)*e*Math.sin(i*f));c=1-c}this.context.closePath();var d=this.context.createRadialGradient(0,0,0,e/2,e/2,e*5);d.addColorStop(0,b.drawColour);d.addColorStop(1,this.gradient.stopCol);this.context.fillStyle=d;this.context.fill();this.context.translate(-b.position.x,-b.position.y)};ParticleEmitter.prototype.update=function(h){if(this.active&&this.emissionRate>0){var n=1/this.emissionRate;this.emitCounter+=h;while(this.particleCount<this.maxParticles&&this.emitCounter>n){this.addParticle();this.emitCounter-=n}this.elapsedTime+=h;if(this.duration!=-1&&this.duration<this.elapsedTime){this.parentClass.stop()}}this.particleIndex=0;while(this.particleIndex<this.particleCount){var f=this.particles[this.particleIndex];if(f.timeToLive>0){f.direction=f.direction.add(this.gravity);f.position=f.position.add(f.direction);if(this.shape=="square"||this.gradient){var l=f.colour[0]+=(f.deltaColour[0]*h);var j=f.colour[1]+=(f.deltaColour[1]*h);var d=f.colour[2]+=(f.deltaColour[2]*h);var c=f.colour[3]+=(f.deltaColour[3]*h);function e(b,g){var a=(b>255?255:b<0?0:b);return(g)?a<<0:a}f.drawColour="rgba("+e(l,true)+","+e(j,true)+","+e(d,true)+","+e(c).toFixed(2)+")"}f.size=f.size+(f.sizeDeltaEnd*h);if(this.gradient&&this.gradient.type=="radial"&&f.shape!=="star"){f.sizeSmall=(((f.size/200)*f.sharpness)<<0)-0.1;if(f.sizeSmall<0){f.sizeSmall=0}var o=f.position.x<<0;var p=f.position.y<<0;var k=f.size>>1;if(k<0){k=0}var m=this.context.createRadialGradient(o,p,f.sizeSmall,o,p,k);m.addColorStop(0,f.drawColour);m.addColorStop(1,this.gradient.stopCol);f.drawColour=m}f.timeToLive-=h;this.particleIndex++}else{if(this.particleIndex!=this.particleCount-1){this.particles[this.particleIndex]=this.particles[this.particleCount-1]}this.particleCount--}}};ParticleEmitter.prototype.addParticle=function(){if(this.particleCount==this.maxParticles){return false}var a=new Particle();this.initParticle(a);this.particles[this.particleCount]=a;a.shape=this.shape;this.particleCount++;return true};ParticleEmitter.prototype.random=function(){return Math.random()*2-1};ParticleEmitter.prototype.initParticle=function(d){d.position.x=this.position.x+this.position.randx*this.random();d.position.y=this.position.y+this.position.randy*this.random();d.timeToLive=this.lifeSpan+this.lifeSpanRandom*this.random();d.size=this.size+this.sizeRandom*this.random();d.size=d.size<0?0:~~d.size;d.sizeEnd=this.sizeEnd+this.sizeRandom*this.random();d.sizeDeltaEnd=(d.sizeEnd-d.size)/d.timeToLive;var b=(this.angle+this.angleRandom*this.random())*(Math.PI/180);b=b.toFixed(2);var g=new Vec(parseFloat(Math.cos(b).toFixed(2)),parseFloat(Math.sin(b).toFixed(2)));var e=this.speed+this.speedRandom*this.random();g=g.multiply(e);d.direction=g;if(this.gradient){d.sharpness=this.gradient.sharpness+this.gradient.sharpnessRandom*this.random();d.sharpness=d.sharpness>100?100:d.sharpness<0?0:d.sharpness}var f=[this.startColour[0]+this.startColourRandom[0]*this.random(),this.startColour[1]+this.startColourRandom[1]*this.random(),this.startColour[2]+this.startColourRandom[2]*this.random(),this.startColour[3]+this.startColourRandom[3]*this.random()];var c=[this.finishColour[0]+this.finishColourRandom[0]*this.random(),this.finishColour[1]+this.finishColourRandom[1]*this.random(),this.finishColour[2]+this.finishColourRandom[2]*this.random(),this.finishColour[3]+this.finishColourRandom[3]*this.random()];d.colour=f;d.deltaColour[0]=(c[0]-f[0])/d.timeToLive;d.deltaColour[1]=(c[1]-f[1])/d.timeToLive;d.deltaColour[2]=(c[2]-f[2])/d.timeToLive;d.deltaColour[3]=(c[3]-f[3])/d.timeToLive};function Emitter(a,b){this.canvas=document.createElement("canvas");this.canvas.width=a.w;this.canvas.height=a.h;this.canvas.id="particles";this.context=this.canvas.getContext("2d");this.blendMode=a.gco;this.drawInterval=a.drawInterval;this.particles=b;this.emitter=new Array();this.ison=false}Emitter.prototype.init=function(){for(var a=0,b=this.particles.length;a<b;a++){this.emitter[a]=new ParticleEmitter(this.particles[a],this);this.emitter[a].init(this.context)}};Emitter.prototype.stop=function(){var a=this;setTimeout(function(){if(this.ison){this.ison=false;window.clearInterval(a.interval)}},this.life);for(var b=0,c=this.emitter.length;b<c;b++){this.emitter[b].stopParticleEmitter()}};Emitter.prototype.start=function(){this.ison=true;var a=this;for(var b=0,c=this.emitter.length;b<c;b++){this.emitter[b].startParticleEmitter()}window.clearInterval(this.interval);this.interval=setInterval(function(){a.update(a.drawInterval)},this.drawInterval)};Emitter.prototype.update=function(b){var a=this;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(var c=0,d=this.emitter.length;c<d;c++){this.emitter[c].update(b);this.emitter[c].renderParticles()}};Custom=function(b,a){this.type=b.type;this.id=b.id;this.runtime=b.runtime;this.delay=b.delay;this.callback=b.callback;this.x=b.x;this.y=b.y;this.customFunction=b.customFunction;this.entity=a;this.run=function(c,d){this.customFunction(c,d,this.entity)};this.end=function(){if(this.callback){this.callback()}}};